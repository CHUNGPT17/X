From ca21bb98773235bc7a50f7bcc1ed990f158f7dbd Mon Sep 17 00:00:00 2001
From: Peter Chiu <chui-hao.chiu@mediatek.com>
Date: Mon, 14 Mar 2022 12:28:13 +0800
Subject: [PATCH] mac80211: allow non-standard VHT MCS-10/11

Change-Id: I75f6b33f1f0ea17faff63ba066e6896ac4bc849a
---
 ...211-allow-non-standard-VHT-MCS-10-11.patch | 41 +++++++++++++++++++
 1 file changed, 41 insertions(+)
 create mode 100644 package/kernel/mac80211/patches/subsys/323-mac80211-allow-non-standard-VHT-MCS-10-11.patch

diff --git a/package/kernel/mac80211/patches/subsys/323-mac80211-allow-non-standard-VHT-MCS-10-11.patch b/package/kernel/mac80211/patches/subsys/323-mac80211-allow-non-standard-VHT-MCS-10-11.patch
new file mode 100644
index 00000000..d9050c1d
--- /dev/null
+++ b/package/kernel/mac80211/patches/subsys/323-mac80211-allow-non-standard-VHT-MCS-10-11.patch
@@ -0,0 +1,41 @@
+From 04be6d337d37400ad5b3d5f27ca87645ee5a18a3 Mon Sep 17 00:00:00 2001
+From: Ping-Ke Shih <pkshih@realtek.com>
+Date: Mon, 3 Jan 2022 09:36:21 +0800
+Subject: [PATCH] mac80211: allow non-standard VHT MCS-10/11
+
+Some AP can possibly try non-standard VHT rate and mac80211 warns and drops
+packets, and leads low TCP throughput.
+
+    Rate marked as a VHT rate but data is invalid: MCS: 10, NSS: 2
+    WARNING: CPU: 1 PID: 7817 at net/mac80211/rx.c:4856 ieee80211_rx_list+0x223/0x2f0 [mac8021
+
+Since commit c27aa56a72b8 ("cfg80211: add VHT rate entries for MCS-10 and MCS-11")
+has added, mac80211 adds this support as well.
+
+After this patch, throughput is good and iw can get the bitrate:
+    rx bitrate:	975.1 MBit/s VHT-MCS 10 80MHz short GI VHT-NSS 2
+or
+    rx bitrate:	1083.3 MBit/s VHT-MCS 11 80MHz short GI VHT-NSS 2
+
+Buglink: https://bugzilla.suse.com/show_bug.cgi?id=1192891
+Reported-by: Goldwyn Rodrigues <rgoldwyn@suse.com>
+Signed-off-by: Ping-Ke Shih <pkshih@realtek.com>
+Link: https://lore.kernel.org/r/20220103013623.17052-1-pkshih@realtek.com
+Signed-off-by: Johannes Berg <johannes.berg@intel.com>
+---
+ net/mac80211/rx.c | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/net/mac80211/rx.c b/net/mac80211/rx.c
+index fec82f7c2fa6f..93680af62c47d 100644
+--- a/net/mac80211/rx.c
++++ b/net/mac80211/rx.c
+@@ -4929,7 +4929,7 @@ void ieee80211_rx_list(struct ieee80211_hw *hw, struct ieee80211_sta *pubsta,
+ 				goto drop;
+ 			break;
+ 		case RX_ENC_VHT:
+-			if (WARN_ONCE(status->rate_idx > 9 ||
++			if (WARN_ONCE(status->rate_idx > 11 ||
+ 				      !status->nss ||
+ 				      status->nss > 8,
+ 				      "Rate marked as a VHT rate but data is invalid: MCS: %d, NSS: %d\n",
\ No newline at end of file
-- 
2.18.0

